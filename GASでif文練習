/**
 * 条件に一致するレコードの最新日付を取得する関数
 * - ターゲットシートE列とソースシートN列が一致
 * - ターゲットシートF列とソースシートO列が一致
 * - 条件を満たすレコードのBL列の中で最新の日付を返す
 * @return {Date|null} - 最新日付または条件に一致するデータがない場合はnull
 */
function getLatestMatchingDate() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const targetSheet = ss.getSheetByName("ターゲットシート");
  const sourceSheet = ss.getSheetByName("ソースシート");
  
  // ターゲットシートのE列とF列の値を取得
  const targetE = targetSheet.getRange("E2").getValue();
  const targetF = targetSheet.getRange("F2").getValue();
  
  // ソースシートのデータを取得
  const sourceData = sourceSheet.getDataRange().getValues();
  let latestDate = null;
  
  // ヘッダー行をスキップして処理
  for (let i = 1; i < sourceData.length; i++) {
    const row = sourceData[i];
    const sourceN = row[13];  // N列 (インデックスは0から)
    const sourceO = row[14];  // O列
    const sourceBL = row[63]; // BL列
    
    // 条件チェック: E=N かつ F=O
    if (targetE === sourceN && targetF === sourceO) {
      // BL列の値が有効な日付で、現在の最新日付より新しい場合に更新
      if (sourceBL instanceof Date && !isNaN(sourceBL.getTime())) {
        if (latestDate === null || sourceBL > latestDate) {
          latestDate = sourceBL;
        }
      }
    }
  }
  
  return latestDate;
}
