function compareAndUpdateSheets() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheetA = ss.getSheetByName("A");
  var sheetB = ss.getSheetByName("B");
  
  var dataA = sheetA.getDataRange().getValues();
  var dataB = sheetB.getDataRange().getValues();
  
  var headerA = dataA[0];
  var headerB = dataB[0];
  
  var idColumnA = headerA.indexOf("ID");
  var confirmColumnA = headerA.indexOf("確認");
  var checkColumnA = headerA.indexOf("チェック");
  
  var idColumnB = headerB.indexOf("ID");
  var confirmColumnB = headerB.indexOf("確認");
  
  if (idColumnA === -1 || confirmColumnA === -1 || checkColumnA === -1 || idColumnB === -1 || confirmColumnB === -1) {
    throw new Error("必要な列が見つかりません。");
  }
  
  var currentDate = new Date();
  var lastMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1);
  var lastMonthTimestamp = Utilities.formatDate(lastMonth, Session.getScriptTimeZone(), "yyyy/MM");
  
  for (var i = 1; i < dataA.length; i++) {
    var idA = dataA[i][idColumnA];
    var dateA = dataA[i][confirmColumnA];
    
    for (var j = 1; j < dataB.length; j++) {
      if (dataB[j][idColumnB] === idA) {
        var dateB = dataB[j][confirmColumnB];
        var cellA = sheetA.getRange(i + 1, confirmColumnA + 1);
        var noteA = cellA.getNote();
        
        var newNote = "";
        if (dateA && dateB && areDatesEqual(dateA, dateB)) {
          // 日付が一致する場合、Bシートのメモを転記
          var noteBCell = sheetB.getRange(j + 1, confirmColumnB + 1);
          var noteB = noteBCell.getNote();
          newNote = noteB;
        } else {
          // 日付が一致しない場合、新しいメモを追加
          if (dateB) {
            newNote = "【" + lastMonthTimestamp + "】 " + Utilities.formatDate(dateB, Session.getScriptTimeZone(), "yyyy/MM/dd");
          } else {
            newNote = "【" + lastMonthTimestamp + "】 \"値なし\"";
            sheetA.getRange(i + 1, checkColumnA + 1).setValue("要確認");
          }
        }
        
        // 既存のメモがある場合は、新しいメモの後に追加
        if (noteA) {
          newNote = newNote + (newNote ? "\n" : "") + noteA;
        }
        
        cellA.setNote(newNote);
        break;
      }
    }
  }
}

function areDatesEqual(date1, date2) {
  if (!(date1 instanceof Date)) date1 = new Date(date1);
  if (!(date2 instanceof Date)) date2 = new Date(date2);
  
  return date1.getFullYear() === date2.getFullYear() &&
         date1.getMonth() === date2.getMonth() &&
         date1.getDate() === date2.getDate();
}
