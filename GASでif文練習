function transferAndUpdateData() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheetA = ss.getSheetByName("Aシート");
  var sheetB = ss.getSheetByName("Bシート");
  
  var dataA = sheetA.getDataRange().getValues();
  var dataB = sheetB.getDataRange().getValues();
  
  var headerA = dataA[0];
  var headerB = dataB[0];
  
  var idIndexA = headerA.indexOf("ID");
  var remarkIndexA = headerA.indexOf("備考");
  var idIndexB = headerB.indexOf("ID");
  var remarkIndexB = headerB.indexOf("備考");
  
  var updatedRows = 0;
  var addedRows = 0;
  
  var newRows = [];
  var updateOperations = [];

  // Step 1: データの分類と新規データの準備
  for (var i = 1; i < dataA.length; i++) {
    var rowA = dataA[i];
    var idA = rowA[idIndexA];
    var remarkA = rowA[remarkIndexA];
    
    if (remarkA && remarkA.trim() !== "") {
      var foundIndex = -1;
      for (var j = 1; j < dataB.length; j++) {
        var remarkB = dataB[j][remarkIndexB];
        if (dataB[j][idIndexB] === idA && remarkB && remarkB.trim() !== "") {
          foundIndex = j;
          break;
        }
      }
      
      var timestamp = Utilities.formatDate(new Date(), "GMT+9", "yyyy/MM");
      var newRemark = timestamp + " " + remarkA;
      
      if (foundIndex === -1) {
        // 新規データの準備
        var newRow = new Array(headerB.length);
        for (var k = 0; k < headerA.length; k++) {
          if (k === remarkIndexB) {
            newRow[k] = newRemark;
          } else {
            newRow[k] = rowA[k];
          }
        }
        newRows.push(newRow);
        addedRows++;
      } else {
        // 更新操作の準備
        updateOperations.push({
          row: foundIndex + 1,
          newData: rowA,
          newRemark: newRemark,
          existingRemark: dataB[foundIndex][remarkIndexB]
        });
      }
    }
  }

  // Step 2: 新規データの追加
  if (newRows.length > 0) {
    var lastRow = sheetB.getLastRow();
    sheetB.getRange(lastRow + 1, 1, newRows.length, headerB.length).setValues(newRows);
  }

  // Step 3: 既存データの更新
  updateOperations.forEach(function(operation) {
    for (var k = 0; k < headerA.length; k++) {
      if (k !== remarkIndexB) {
        sheetB.getRange(operation.row, k + 1).setValue(operation.newData[k]);
      }
    }
    sheetB.getRange(operation.row, remarkIndexB + 1).setValue(operation.newRemark + "\n" + operation.existingRemark);
    updatedRows++;
  });
  
  Logger.log("追加された行数: " + addedRows);
  Logger.log("更新された行数: " + updatedRows);
}
